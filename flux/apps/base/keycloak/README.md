# Keycloak

Identity and access management solution for modern applications.

## Setup

This deployment uses the Keycloak Operator with PostgreSQL (CNPG) as the database backend.

### Components

- **Operator**: Manages Keycloak instance lifecycle
- **Instance**: Keycloak server configured for reverse proxy
- **Database**: PostgreSQL cluster (managed by CNPG)
- **Ingress**: Exposed via Istio Gateway HTTPRoute

### Configuration

The Keycloak instance is configured for deployment behind Istio Gateway with Cloudflare Tunnel:

```yaml
hostname:
  hostname: keycloak.kubegit.com
  strict: false                    # Allow dynamic hostname resolution
additionalOptions:
  - name: hostname-strict-https
    value: "false"                 # Generate HTTPS URLs from HTTP backend
proxy:
  headers: xforwarded              # Trust X-Forwarded-* headers
http:
  httpEnabled: true                # Accept HTTP from Istio Gateway
```

**Why this configuration?**

1. **Cloudflare Tunnel** terminates TLS and forwards HTTP to Istio Gateway (port 80)
2. **Istio Gateway** adds `X-Forwarded-Proto: https` header via HTTPRoute filter
3. **Keycloak** reads the header and generates correct HTTPS URLs for redirects
4. **strict: false** allows Keycloak to trust reverse proxy headers
5. **hostname-strict-https: false** prevents forcing HTTPS when backend is HTTP

## Access

- **URL**: https://keycloak.kubegit.com
- **Admin Console**: https://keycloak.kubegit.com/admin/

Default admin credentials are auto-generated by the operator. Retrieve them with:

```bash
kubectl exec -n keycloak keycloak-0 -- env | grep KC_BOOTSTRAP_ADMIN
```

**Change the default password immediately after first login!**

## Database

Keycloak uses a PostgreSQL cluster managed by CloudNativePG:

```bash
kubectl get cluster -n keycloak keycloak-postgres
```

Database credentials are stored in the `keycloak-postgres-app` secret.

## Troubleshooting

Check Keycloak pod logs:
```bash
kubectl logs -n keycloak keycloak-0
```

Check operator logs:
```bash
kubectl logs -n keycloak -l app.kubernetes.io/name=keycloak-operator
```

Verify HTTPRoute configuration:
```bash
kubectl describe httproute keycloak-route -n istio-system
```

## Notes

- The Keycloak Operator manages the StatefulSet and rolling updates
- Metrics are disabled by default (enable with `metrics-enabled: true`)
- Database backups are handled by CNPG (see `apps/base/cnpg/cluster/keycloak-postgres.yaml`)
