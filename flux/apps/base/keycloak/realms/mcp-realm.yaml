---
apiVersion: k8s.keycloak.org/v2alpha1
kind: KeycloakRealmImport
metadata:
  name: mcp-realm
  namespace: keycloak
spec:
  keycloakCRName: keycloak
  realm:
    id: mcp
    realm: mcp
    displayName: "MCP Authentication"
    enabled: true

    # Token settings
    accessTokenLifespan: 300
    ssoSessionIdleTimeout: 1800
    ssoSessionMaxLifespan: 36000

    # Login settings
    registrationAllowed: false
    resetPasswordAllowed: true
    rememberMe: true
    verifyEmail: false
    loginWithEmailAllowed: true
    duplicateEmailsAllowed: false

    # Clients configuration
    clients:
      # Public client for user authentication
      - clientId: mcp-test-client
        name: "MCP Test Client"
        description: "Public client for MCP user authentication"
        enabled: true

        # Client authentication settings
        publicClient: true
        bearerOnly: false
        standardFlowEnabled: true
        implicitFlowEnabled: false
        directAccessGrantsEnabled: true
        serviceAccountsEnabled: false

        # OAuth settings
        protocol: openid-connect
        fullScopeAllowed: false

        # URLs
        rootUrl: ""
        baseUrl: ""
        redirectUris:
          - "http://localhost:*/*"
          - "http://127.0.0.1:*/*"
        webOrigins:
          - "*"

        # Client scopes
        defaultClientScopes:
          - "profile"
          - "email"
          - "roles"
          - "web-origins"
          - "echo-mcp-server-audience"
        optionalClientScopes:
          - "address"
          - "phone"
          - "offline_access"
          - "mcp:read"
          - "mcp:tools"
          - "mcp:prompts"

      # Confidential client representing the MCP server
      - clientId: echo-mcp-server
        name: "Echo MCP Server"
        description: "Confidential client representing the MCP server resource"
        enabled: true

        # Client authentication settings
        publicClient: false
        bearerOnly: true
        standardFlowEnabled: false
        implicitFlowEnabled: false
        directAccessGrantsEnabled: false
        serviceAccountsEnabled: false

        # OAuth settings
        protocol: openid-connect
        fullScopeAllowed: false

        # Client secret - you should change this
        secret: "PLOs4j6ti521kb5ZVVVwi5GWi9eDYTwq"

    # Client Scopes
    clientScopes:
      # Audience mapper for echo-mcp-server
      - name: "echo-mcp-server-audience"
        description: "Adds echo-mcp-server to token audience"
        protocol: "openid-connect"
        attributes:
          include.in.token.scope: "true"
          display.on.consent.screen: "false"
        protocolMappers:
          - name: "echo-mcp-server-audience-mapper"
            protocol: "openid-connect"
            protocolMapper: "oidc-audience-mapper"
            consentRequired: false
            config:
              included.client.audience: "echo-mcp-server"
              id.token.claim: "false"
              access.token.claim: "true"

      # MCP scopes with role mappings
      - name: "mcp:read"
        description: "Read access to MCP resources"
        protocol: "openid-connect"
        attributes:
          include.in.token.scope: "true"
          display.on.consent.screen: "true"

      - name: "mcp:tools"
        description: "Access to execute MCP tools"
        protocol: "openid-connect"
        attributes:
          include.in.token.scope: "true"
          display.on.consent.screen: "true"

      - name: "mcp:prompts"
        description: "Access to MCP prompts"
        protocol: "openid-connect"
        attributes:
          include.in.token.scope: "true"
          display.on.consent.screen: "true"

    # Roles
    roles:
      realm:
        - name: "user"
          description: "Standard user role"
        - name: "admin"
          description: "Administrator role"
      client:
        echo-mcp-server:
          - name: "tools"
            description: "Can call tools"
          - name: "prompts"
            description: "Can call prompts"
          - name: "read-only"
            description: "Can read resources"

    # Create test users
    users:
      - username: "mcp-admin"
        enabled: true
        emailVerified: true
        email: "admin@mcp.example.com"
        firstName: "MCP"
        lastName: "Admin"
        credentials:
          - type: "password"
            value: "admin123"
            temporary: false
        realmRoles:
          - "admin"
        clientRoles:
          echo-mcp-server:
            - "tools"
            - "prompts"
            - "read-only"

      - username: "mcp-user"
        enabled: true
        emailVerified: true
        email: "user@mcp.example.com"
        firstName: "MCP"
        lastName: "User"
        credentials:
          - type: "password"
            value: "user123"
            temporary: false
        realmRoles:
          - "user"
        clientRoles:
          echo-mcp-server:
            - "tools"
            - "read-only"

      - username: "mcp-readonly"
        enabled: true
        emailVerified: true
        email: "readonly@mcp.example.com"
        firstName: "MCP"
        lastName: "ReadOnly"
        credentials:
          - type: "password"
            value: "readonly123"
            temporary: false
        realmRoles:
          - "user"
        clientRoles:
          echo-mcp-server:
            - "read-only"
