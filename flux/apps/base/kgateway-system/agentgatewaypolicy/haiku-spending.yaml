---
# Retry policy for the Haiku gateway
# Instead of rejecting requests with a local rate limit, let requests
# through to Anthropic and automatically retry on 429 (rate limit) with
# exponential backoff. The caller never sees rate limit errors.
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayPolicy
metadata:
  name: haiku-retry-policy
  namespace: kgateway-system
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: claude-haiku-route
  traffic:
    retry:
      attempts: 5
      backoff: 30s
      codes:
        - 429
        - 529
