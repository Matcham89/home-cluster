apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: agentgateway-gateways
  namespace: monitoring
  labels:
    release: kube-prometheus-stack
    app: agentgateway
spec:
  namespaceSelector:
    matchNames:
      - kgateway-system

  # This cleanly targets ONLY dataplane pods because they all have:
  # gateway.networking.k8s.io/gateway-name=<gateway object name>
  # Your controller pod does NOT, so it won't be scraped.
  selector:
    matchExpressions:
      - key: gateway.networking.k8s.io/gateway-name
        operator: Exists

  podMetricsEndpoints:
    - port: metrics
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s

      relabelings:
        # Basics
        - sourceLabels: [__meta_kubernetes_pod_name]
          targetLabel: pod
        - sourceLabels: [__meta_kubernetes_namespace]
          targetLabel: namespace

        # Canonical gateway identity (matches Gateway object name)
        - sourceLabels: [__meta_kubernetes_pod_label_gateway_networking_k8s_io_gateway_name]
          targetLabel: gateway_name

        # Keep compatibility with your existing rules/dashboards:
        # gateway_instance == gateway_name (truthy, stable, no guessing)
        - sourceLabels: [__meta_kubernetes_pod_label_gateway_networking_k8s_io_gateway_name]
          targetLabel: gateway_instance

        # Optional: tag Claude gateways with provider/model (only when it matches)
        - sourceLabels: [gateway_name]
          regex: claude-(sonnet|opus|haiku)-gateway
          targetLabel: provider
          replacement: anthropic

        - sourceLabels: [gateway_name]
          regex: claude-sonnet-gateway
          targetLabel: model
          replacement: sonnet-4-5

        - sourceLabels: [gateway_name]
          regex: claude-opus-gateway
          targetLabel: model
          replacement: opus-4-5

        - sourceLabels: [gateway_name]
          regex: claude-haiku-gateway
          targetLabel: model
          replacement: haiku-4-5

        # Optional: tag ollama gateway
        - sourceLabels: [gateway_name]
          regex: gateway-ollama
          targetLabel: provider
          replacement: ollama

      metricRelabelings:
        - sourceLabels: [__name__]
          regex: '.*_info'
          action: drop
