---
# HTTPRoute for browser access to Open WebUI
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: open-webui
  namespace: kgateway-system
  labels:
    app: agentgateway
spec:
  parentRefs:
    - name: agentgateway
      namespace: kgateway-system
      sectionName: https-openwebui
  hostnames:
    - "open-webui.kubegit.com"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      filters:
        - type: RequestHeaderModifier
          requestHeaderModifier:
            set:
              - name: X-Forwarded-Port
                value: "443"
              - name: X-Forwarded-Proto
                value: "https"
      backendRefs:
        - name: open-webui
          namespace: open-webui
          kind: Service
          port: 80
---
# Static backend pointing to Open WebUI service
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  name: open-webui-backend
  namespace: kgateway-system
  labels:
    app: agentgateway
spec:
  static:
    host: open-webui.open-webui.svc.cluster.local
    port: 80
---
# HTTPRoute for /v1/models endpoint (direct passthrough, no AI parsing)
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: ollama-models
  namespace: kgateway-system
  labels:
    app: agentgateway
spec:
  parentRefs:
    - name: agentgateway
      namespace: kgateway-system
      sectionName: http
  hostnames:
    - "ollama.kubegit.com"
  rules:
    - matches:
        - path:
            type: Exact
            value: /v1/models
      backendRefs:
        - name: ollama-passthrough
          namespace: kgateway-system
          group: agentgateway.dev
          kind: AgentgatewayBackend
---
# HTTPRoute for chat completions (AI backend with token tracking)
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: ollama-api
  namespace: kgateway-system
  labels:
    app: agentgateway
spec:
  parentRefs:
    - name: agentgateway
      namespace: kgateway-system
      sectionName: http
  hostnames:
    - "ollama.kubegit.com"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /v1/chat
      backendRefs:
        - name: ollama-backend
          namespace: kgateway-system
          group: agentgateway.dev
          kind: AgentgatewayBackend
    - matches:
        - path:
            type: PathPrefix
            value: /v1/completions
      backendRefs:
        - name: ollama-backend
          namespace: kgateway-system
          group: agentgateway.dev
          kind: AgentgatewayBackend
---
# Static backend for /v1/models endpoint (no AI parsing)
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  name: ollama-passthrough
  namespace: kgateway-system
  labels:
    app: agentgateway
spec:
  static:
    host: "192.168.1.200"
    port: 11434
---
# AI backend for chat/completions (OpenAI-compatible API with token tracking)
# Model passthrough - supports all Ollama models
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  name: ollama-backend
  namespace: kgateway-system
  labels:
    app: agentgateway
spec:
  ai:
    groups:
      - providers:
          - name: ollama
            openai: {}  # Passthrough mode - supports all models
            host: "192.168.1.200"
            port: 11434
---
# HTTPRoute for Claude models endpoint (static response)
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: claude-models
  namespace: kgateway-system
  labels:
    app: agentgateway
spec:
  parentRefs:
    - name: agentgateway
      namespace: kgateway-system
      sectionName: http
  hostnames:
    - "claude.kubegit.com"
  rules:
    - matches:
        - path:
            type: Exact
            value: /v1/models
      backendRefs:
        - name: claude-models-backend
          namespace: kgateway-system
          kind: Service
          port: 80
---
# HTTPRoute for Claude chat completions
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: claude-api
  namespace: kgateway-system
  labels:
    app: agentgateway
spec:
  parentRefs:
    - name: agentgateway
      namespace: kgateway-system
      sectionName: http
  hostnames:
    - "claude.kubegit.com"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /v1/chat
      backendRefs:
        - name: claude-backend
          namespace: kgateway-system
          group: agentgateway.dev
          kind: AgentgatewayBackend
    - matches:
        - path:
            type: PathPrefix
            value: /v1/completions
      backendRefs:
        - name: claude-backend
          namespace: kgateway-system
          group: agentgateway.dev
          kind: AgentgatewayBackend
---
# AI backend for Claude (Anthropic API with model passthrough)
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  name: claude-backend
  namespace: kgateway-system
  labels:
    app: agentgateway
spec:
  ai:
    groups:
      - providers:
          - name: claude
            anthropic: {}  # Passthrough mode - supports all models
            policies:
              auth:
                secretRef:
                  name: anthropic-secret
