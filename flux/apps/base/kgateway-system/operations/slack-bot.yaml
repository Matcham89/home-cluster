# Slack Bot A2A Gateway Configuration
#
# Configures AgentGateway to route A2A protocol requests to kagent-controller,
# enabling the Slack bot (https://github.com/your-org/slackbot-agent) to interact
# with Kagent agents via the A2A protocol.
#
# Components:
# - ReferenceGrant: Allows cross-namespace access from kgateway-system to kagent
# - Gateway: Exposes AgentGateway on port 8080 (LoadBalancer: 192.168.1.201)
# - HTTPRoute: Routes /api/a2a/* to kagent-controller:8083
#
# Test endpoints:
#   curl http://192.168.1.201:8080/api/a2a/kagent/k8s-agent/.well-known/agent.json
#
# Note: Ensure trailing slash on POST requests to /api/a2a/kagent/{agent}/
#
# Related: /Users/chris/Documents/github/slackbot-agent/k8s-deployment.yaml

---
apiVersion: gateway.networking.k8s.io/v1beta1
kind: ReferenceGrant
metadata:
  name: allow-kgateway-to-kagent
  namespace: kagent
spec:
  from:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      namespace: kgateway-system
  to:
    - group: ""
      kind: Service
---
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: agentgateway
  namespace: kgateway-system
spec:
  gatewayClassName: agentgateway
  listeners:
  - protocol: HTTP
    port: 8080
    name: http
  - protocol: HTTPS
    port: 8443
    name: https
    hostname: "agentgateway.kubegit.com"
    tls:
      mode: Terminate
      certificateRefs:
      - name: agentgateway-tls
        kind: Secret
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: slack-bot-a2a
  namespace: kgateway-system
spec:
  parentRefs:
    - name: agentgateway
      namespace: kgateway-system
      sectionName: http  # Bind to HTTP listener
    - name: agentgateway
      namespace: kgateway-system
      sectionName: https  # Bind to HTTPS listener
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /api/a2a/
      backendRefs:
        - name: kagent-controller
          namespace: kagent
          port: 8083