---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: istiod
spec:
  interval: 1m
  dependsOn:
    - name: istio-base
  chart:
    spec:
      chart: istiod
      version: 1.28.1
      sourceRef:
        kind: HelmRepository
        name: istio
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    meshConfig:
      enableTracing: true
      extensionProviders:
      - name: otel-tracing
        opentelemetry:
          port: 4317
          service: otel-collector-collector.monitoring.svc.cluster.local
    # Ambient mode only.
    # Set this if you install ztunnel to a different namespace from `istiod`.
    # If set, `istiod` will allow connections from trusted node proxy ztunnels
    # in the provided namespace.
    # If unset, `istiod` will assume the trusted node proxy ztunnel resides
    # in the same namespace as itself.
    trustedZtunnelNamespace: ""
    # Set this if you install ztunnel with a name different from the default.
    trustedZtunnelName: ""

    sidecarInjectorWebhook:
      # You can use the field called alwaysInjectSelector and neverInjectSelector which will always inject the sidecar or
      # always skip the injection on pods that match that label selector, regardless of the global policy.
      # See https://istio.io/docs/setup/kubernetes/additional-setup/sidecar-injection/#more-control-adding-exceptions
      neverInjectSelector: []
      alwaysInjectSelector: []

      # injectedAnnotations are additional annotations that will be added to the pod spec after injection
      # This is primarily to support PSP annotations. For example, if you defined a PSP with the annotations:
      #
      # annotations:
      #   apparmor.security.beta.kubernetes.io/allowedProfileNames: runtime/default
      #   apparmor.security.beta.kubernetes.io/defaultProfileName: runtime/default
      #
      # The PSP controller would add corresponding annotations to the pod spec for each container. However, this happens before
      # the inject adds additional containers, so we must specify them explicitly here. With the above example, we could specify:
      # injectedAnnotations:
      #   container.apparmor.security.beta.kubernetes.io/istio-init: runtime/default
      #   container.apparmor.security.beta.kubernetes.io/istio-proxy: runtime/default
      injectedAnnotations: {}

      # This enables injection of sidecar in all namespaces,
      # with the exception of namespaces with "istio-injection:disabled" annotation
      # Only one environment should have this enabled.
      enableNamespacesByDefault: false

      # Mutations that occur after the sidecar injector are not handled by default, as the Istio sidecar injector is only run
      # once. For example, an OPA sidecar injected after the Istio sidecar will not have it's liveness/readiness probes rewritten.
      # Setting this to `IfNeeded` will result in the sidecar injector being run again if additional mutations occur.
      reinvocationPolicy: Never

      rewriteAppHTTPProbe: true

      # Templates defines a set of custom injection templates that can be used. For example, defining:
      #
      # templates:
      #   hello: |
      #     metadata:
      #       labels:
      #         hello: world
      #
      # Then starting a pod with the `inject.istio.io/templates: hello` annotation, will result in the pod
      # being injected with the hello=world labels.
      # This is intended for advanced configuration only; most users should use the built in template
      templates: {}

      # Default templates specifies a set of default templates that are used in sidecar injection.
      # By default, a template `sidecar` is always provided, which contains the template of default sidecar.
      # To inject other additional templates, define it using the `templates` option, and add it to
      # the default templates list.
      # For example:
      #
      # templates:
      #   hello: |
      #     metadata:
      #       labels:
      #         hello: world
      #
      # defaultTemplates: ["sidecar", "hello"]
      defaultTemplates: []
