apiVersion: kagent.dev/v1alpha1
kind: MCPServer
metadata:
  name: flux-mcp
  namespace: kagent
  annotations:
    kmcp.dev/project-name: flux-mcp
  labels:
    app.kubernetes.io/name: flux-mcp
    kmcp.dev/framework: flux-operator-mcp
spec:
  deployment:
    image: ghcr.io/controlplaneio-fluxcd/flux-operator-mcp:v0.41.1
    cmd: /flux-operator-mcp
    args:
      - serve
    port: 3000
  stdioTransport: {}
  transportType: stdio
---
apiVersion: v1
kind: Service
metadata:
  name: flux-mcp-kagent
  namespace: kagent
  annotations:
    kagent.dev/mcp-service-path: /mcp
    kagent.dev/mcp-service-port: "3000"
  labels:
    kagent.dev/mcp-service: "true"
    app.kubernetes.io/name: flux-mcp
    app: flux-mcp
spec:
  selector:
    app.kubernetes.io/instance: flux-mcp
    app.kubernetes.io/name: flux-mcp
  ports:
    - appProtocol: kgateway.dev/mcp
      name: mcp
      port: 3000
      protocol: TCP
      targetPort: 3000
  type: ClusterIP
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: flux-mcp-reader
rules:
  - apiGroups: ["kustomize.toolkit.fluxcd.io"]
    resources: ["kustomizations"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["helm.toolkit.fluxcd.io"]
    resources: ["helmreleases"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["source.toolkit.fluxcd.io"]
    resources: ["gitrepositories", "helmrepositories", "helmcharts", "ocirepositories", "buckets"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["fluxcd.controlplane.io"]
    resources: ["fluxinstances"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["namespaces", "pods", "events"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["kustomize.toolkit.fluxcd.io"]
    resources: ["kustomizations/status"]
    verbs: ["get"]
  - apiGroups: ["helm.toolkit.fluxcd.io"]
    resources: ["helmreleases/status"]
    verbs: ["get"]
  - apiGroups: ["kustomize.toolkit.fluxcd.io"]
    resources: ["kustomizations"]
    verbs: ["patch"]
  - apiGroups: ["helm.toolkit.fluxcd.io"]
    resources: ["helmreleases"]
    verbs: ["patch"]
  - apiGroups: ["source.toolkit.fluxcd.io"]
    resources: ["gitrepositories", "helmrepositories", "helmcharts", "ocirepositories", "buckets"]
    verbs: ["patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: flux-mcp-reader-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: flux-mcp-reader
subjects:
  - kind: ServiceAccount
    name: flux-mcp
    namespace: kagent
