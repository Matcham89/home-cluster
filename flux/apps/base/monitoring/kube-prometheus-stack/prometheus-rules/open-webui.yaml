---
# PrometheusRule for Open WebUI specific metrics
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: open-webui-metrics
  namespace: monitoring
  labels:
    release: kube-prometheus-stack
spec:
  groups:
    - name: open_webui_usage_tracking
      interval: 30s
      rules:
        # Token usage for ollama route (Open WebUI traffic)
        - record: openwebui:input_tokens:5m
          expr: |
            sum(increase(agentgateway_gen_ai_client_token_usage_sum{
              gen_ai_token_type="input",
              route="kgateway-system/ollama-api"
            }[5m]))

        - record: openwebui:output_tokens:5m
          expr: |
            sum(increase(agentgateway_gen_ai_client_token_usage_sum{
              gen_ai_token_type="output",
              route="kgateway-system/ollama-api"
            }[5m]))

        # Token usage by model
        - record: openwebui:input_tokens:by_model
          expr: |
            sum by (gen_ai_request_model) (
              increase(agentgateway_gen_ai_client_token_usage_sum{
                gen_ai_token_type="input",
                route="kgateway-system/ollama-api"
              }[5m])
            )

        - record: openwebui:output_tokens:by_model
          expr: |
            sum by (gen_ai_request_model) (
              increase(agentgateway_gen_ai_client_token_usage_sum{
                gen_ai_token_type="output",
                route="kgateway-system/ollama-api"
              }[5m])
            )

        # Total tokens by model (hourly)
        - record: openwebui:total_tokens:by_model:1h
          expr: |
            sum by (gen_ai_request_model) (
              increase(agentgateway_gen_ai_client_token_usage_sum{
                route="kgateway-system/ollama-api"
              }[1h])
            )

        # Request count by model
        - record: openwebui:requests:by_model:5m
          expr: |
            sum by (gen_ai_request_model) (
              increase(agentgateway_gen_ai_client_operation_duration_count{
                route="kgateway-system/ollama-api"
              }[5m])
            )

        # Average request duration by model
        - record: openwebui:request_duration:by_model:avg
          expr: |
            sum by (gen_ai_request_model) (
              rate(agentgateway_gen_ai_client_operation_duration_sum{
                route="kgateway-system/ollama-api"
              }[5m])
            ) /
            sum by (gen_ai_request_model) (
              rate(agentgateway_gen_ai_client_operation_duration_count{
                route="kgateway-system/ollama-api"
              }[5m])
            )

        # Total requests (all models)
        - record: openwebui:requests:total:5m
          expr: |
            sum(increase(agentgateway_gen_ai_client_operation_duration_count{
              route="kgateway-system/ollama-api"
            }[5m]))

        # Hourly token usage
        - record: openwebui:tokens:hourly
          expr: |
            sum(increase(agentgateway_gen_ai_client_token_usage_sum{
              route="kgateway-system/ollama-api"
            }[1h]))

        # Daily token usage
        - record: openwebui:tokens:daily
          expr: |
            sum(increase(agentgateway_gen_ai_client_token_usage_sum{
              route="kgateway-system/ollama-api"
            }[24h]))

        # Ollama cost tracking (free/self-hosted, but track token usage for comparison)
        # These are for informational purposes - what it would cost if using a paid provider
        # Using qwen2.5 comparable pricing (similar to GPT-3.5): $0.50/1M input, $1.50/1M output
        - record: openwebui:cost_equivalent_usd:hourly
          expr: |
            (
              sum(increase(agentgateway_gen_ai_client_token_usage_sum{
                gen_ai_token_type="input",
                route="kgateway-system/ollama-api"
              }[1h])) * 0.50 / 1000000
            ) + (
              sum(increase(agentgateway_gen_ai_client_token_usage_sum{
                gen_ai_token_type="output",
                route="kgateway-system/ollama-api"
              }[1h])) * 1.50 / 1000000
            )

        - record: openwebui:cost_equivalent_usd:daily
          expr: |
            (
              sum(increase(agentgateway_gen_ai_client_token_usage_sum{
                gen_ai_token_type="input",
                route="kgateway-system/ollama-api"
              }[24h])) * 0.50 / 1000000
            ) + (
              sum(increase(agentgateway_gen_ai_client_token_usage_sum{
                gen_ai_token_type="output",
                route="kgateway-system/ollama-api"
              }[24h])) * 1.50 / 1000000
            )

        - record: openwebui:cost_equivalent_usd:monthly
          expr: |
            (
              sum(increase(agentgateway_gen_ai_client_token_usage_sum{
                gen_ai_token_type="input",
                route="kgateway-system/ollama-api"
              }[30d])) * 0.50 / 1000000
            ) + (
              sum(increase(agentgateway_gen_ai_client_token_usage_sum{
                gen_ai_token_type="output",
                route="kgateway-system/ollama-api"
              }[30d])) * 1.50 / 1000000
            )
