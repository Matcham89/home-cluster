apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-standalone-dashboard
  namespace: monitoring
  labels:
    grafana_dashboard: "1"
data:
  postgres-standalone.json: |-
    {
      "title": "PostgreSQL Standalone Monitor (Sane)",
      "uid": "postgres-standalone-sane",
      "schemaVersion": 39,
      "timezone": "browser",
      "refresh": "30s",
      "panels": [

        {
          "type": "stat",
          "title": "Postgres Up",
          "gridPos": { "x": 0, "y": 0, "w": 4, "h": 4 },
          "targets": [
            {
              "expr": "max(pg_up{service=\"postgres-external\"})",
              "instant": true
            }
          ],
          "options": {
            "reduceOptions": { "calcs": ["lastNotNull"] }
          },
          "fieldConfig": {
            "defaults": {
              "mappings": [
                {
                  "type": "value",
                  "options": {
                    "0": { "text": "DOWN", "color": "red" },
                    "1": { "text": "UP", "color": "green" }
                  }
                }
              ],
              "thresholds": {
                "steps": [
                  { "color": "red", "value": 0 },
                  { "color": "green", "value": 1 }
                ]
              }
            }
          }
        },

        {
          "type": "stat",
          "title": "Uptime",
          "gridPos": { "x": 4, "y": 0, "w": 4, "h": 4 },
          "targets": [
            {
              "expr": "time() - max(pg_postmaster_start_time_seconds{service=\"postgres-external\"})",
              "instant": true
            }
          ],
          "options": {
            "reduceOptions": { "calcs": ["lastNotNull"] }
          },
          "fieldConfig": {
            "defaults": { "unit": "s" }
          }
        },

        {
          "type": "stat",
          "title": "Database Size",
          "gridPos": { "x": 8, "y": 0, "w": 4, "h": 4 },
          "targets": [
            {
              "expr": "max(pg_database_size_bytes{service=\"postgres-external\",datname!~\"template.*\"})",
              "instant": true
            }
          ],
          "options": {
            "reduceOptions": { "calcs": ["lastNotNull"] }
          },
          "fieldConfig": {
            "defaults": { "unit": "decbytes" }
          }
        },

        {
          "type": "stat",
          "title": "Longest Open Transaction",
          "gridPos": { "x": 12, "y": 0, "w": 6, "h": 4 },
          "targets": [
            {
              "expr": "max(pg_stat_activity_max_tx_duration{service=\"postgres-external\"})",
              "instant": true
            }
          ],
          "options": {
            "reduceOptions": { "calcs": ["lastNotNull"] }
          },
          "fieldConfig": {
            "defaults": {
              "unit": "s",
              "thresholds": {
                "steps": [
                  { "color": "green" },
                  { "color": "orange", "value": 30 },
                  { "color": "red", "value": 60 }
                ]
              }
            }
          }
        },

        {
          "type": "gauge",
          "title": "Active Connections",
          "gridPos": { "x": 18, "y": 0, "w": 6, "h": 4 },
          "targets": [
            {
              "expr": "sum(pg_stat_activity_count{service=\"postgres-external\",state=\"active\"})",
              "instant": true
            }
          ],
          "options": {
            "reduceOptions": { "calcs": ["lastNotNull"] }
          },
          "fieldConfig": {
            "defaults": {
              "min": 0,
              "thresholds": {
                "steps": [
                  { "color": "green" },
                  { "color": "orange", "value": 50 },
                  { "color": "red", "value": 100 }
                ]
              }
            }
          }
        },

        {
          "type": "timeseries",
          "title": "Transactions / Second",
          "gridPos": { "x": 0, "y": 4, "w": 24, "h": 8 },
          "targets": [
            {
              "expr": "rate(pg_stat_database_xact_commit{service=\"postgres-external\"}[5m]) + rate(pg_stat_database_xact_rollback{service=\"postgres-external\"}[5m])",
              "legendFormat": "TPS"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "ops"
            }
          }
        },

        {
          "type": "timeseries",
          "title": "Cache Hit Ratio (%)",
          "gridPos": { "x": 0, "y": 12, "w": 12, "h": 7 },
          "targets": [
            {
              "expr": "100 * sum(rate(pg_stat_database_blks_hit{service=\"postgres-external\"}[5m])) / (sum(rate(pg_stat_database_blks_hit{service=\"postgres-external\"}[5m])) + sum(rate(pg_stat_database_blks_read{service=\"postgres-external\"}[5m])))",
              "legendFormat": "Hit Ratio"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "percent",
              "min": 90,
              "max": 100
            }
          }
        },

        {
          "type": "timeseries",
          "title": "Database Size Over Time",
          "gridPos": { "x": 12, "y": 12, "w": 12, "h": 7 },
          "targets": [
            {
              "expr": "max(pg_database_size_bytes{service=\"postgres-external\",datname!~\"template.*\"})",
              "legendFormat": "Size"
            }
          ],
          "fieldConfig": {
            "defaults": { "unit": "decbytes" }
          }
        }

      ]
    }
