apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-standalone-dashboard
  namespace: monitoring
  labels:
    grafana_dashboard: "1"
data:
  postgres-standalone.json: |-
    {
      "title": "PostgreSQL Standalone (Docker / Homelab)",
      "uid": "postgres-homelab",
      "schemaVersion": 39,
      "timezone": "browser",
      "refresh": "30s",
      "panels": [

        {
          "type": "stat",
          "title": "Postgres Reachable",
          "gridPos": { "x": 0, "y": 0, "w": 6, "h": 4 },
          "targets": [
            {
              "expr": "max(pg_up)",
              "instant": true
            }
          ],
          "options": {
            "reduceOptions": { "calcs": ["lastNotNull"] }
          },
          "fieldConfig": {
            "defaults": {
              "mappings": [
                {
                  "type": "value",
                  "options": {
                    "0": { "text": "NO", "color": "red" },
                    "1": { "text": "YES", "color": "green" }
                  }
                }
              ]
            }
          }
        },

        {
          "type": "stat",
          "title": "Postgres Uptime",
          "gridPos": { "x": 6, "y": 0, "w": 6, "h": 4 },
          "targets": [
            {
              "expr": "time() - max(pg_postmaster_start_time_seconds)",
              "instant": true
            }
          ],
          "options": {
            "reduceOptions": { "calcs": ["lastNotNull"] }
          },
          "fieldConfig": {
            "defaults": { "unit": "s" }
          }
        },

        {
          "type": "stat",
          "title": "Total Database Size",
          "gridPos": { "x": 12, "y": 0, "w": 6, "h": 4 },
          "targets": [
            {
              "expr": "sum(pg_database_size_bytes{datname!~\"template.*\"})",
              "instant": true
            }
          ],
          "options": {
            "reduceOptions": { "calcs": ["lastNotNull"] }
          },
          "fieldConfig": {
            "defaults": { "unit": "decbytes" }
          }
        },

        {
          "type": "timeseries",
          "title": "Transactions / Second",
          "gridPos": { "x": 0, "y": 4, "w": 24, "h": 7 },
          "targets": [
            {
              "expr": "rate(pg_stat_database_xact_commit[5m]) + rate(pg_stat_database_xact_rollback[5m])",
              "legendFormat": "TPS"
            }
          ]
        },

        {
          "type": "timeseries",
          "title": "Active Connections",
          "gridPos": { "x": 0, "y": 11, "w": 12, "h": 6 },
          "targets": [
            {
              "expr": "sum(pg_stat_activity_count{state=\"active\"})",
              "legendFormat": "Active"
            }
          ]
        },

        {
          "type": "timeseries",
          "title": "Cache Hit Ratio (%)",
          "gridPos": { "x": 12, "y": 11, "w": 12, "h": 6 },
          "targets": [
            {
              "expr": "100 * sum(rate(pg_stat_database_blks_hit[5m])) / (sum(rate(pg_stat_database_blks_hit[5m])) + sum(rate(pg_stat_database_blks_read[5m])))",
              "legendFormat": "Hit Ratio"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "percent",
              "min": 90,
              "max": 100
            }
          }
        }

      ]
    }
